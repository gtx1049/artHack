##DEX文件格式

### 1. 文件总体结构

DEX的总体文件结构如下所示：

![img]()

对于我们的解析程序来说，最重要部分包括以下4块：Header，其提供关于DEX文件的所有基本信息。*string\_ids*数据块，其包含了整个DEX程序中所有用到的字符串包括类名、方法名等等，我们必须经过这一数据域才能搜索到我们所需要的相关类。_class\_defs_，关于类的一般信息记录在这里，我们的解析程序是以类作为提取单位的。*method\_ids*数据块，记录所有的方法信息。

### 2. Dex Header

Dex Header的文件结构如下所示：

![img]()

可以看到，Header中记录了Dex文件中各个数据类型项的尺寸，以及数据项组的起始偏移。

### 3. class_def数据块

在我们的解析程序中，最重要的信息就是class信息，由Header中的*class\_defs\_off*可以索引到_class\_def\_item_序列的起始位置，*class\_def\_item*结构如下所示：

![img]()

通过对*class\_idx*的索引，可以搜索到对应的_type\_ids_，而*type\_id\_item*中只有一个属性，指向字符集的下标，从而进一步得到这一class对应的字符串，即类名。另一个关于类的重要信息是由*class\_data\_off*提供的，其索引到class的具体数据项。如下所示：

![img]()

可以看到在这一结构中，有四种数据域，包括静态数据域、实例域、直接方法和虚方法，直接方法包括任何的静态方法，私有方法和构造方法，而虚方法中包含除上述以外的所有方法。

### 4. encoded_method数据块

方法是以_encoded\_method_形式存在的，其结构如下：

![img]()

可以看到所有数据的格式都是uleb128，对于这一格式的说明可以在[uleb128]()章节中查看。第一项*method\_idx\_diff*是方法id值的索引，对应于在文件总结构中看到的_method\_ids_区块。根据这一id值进行索引，可以进一步获取type值，最终得到的方法名。而访问标志可以确定方法的类型。第三项属性为代码偏移，通过这一偏移就可以得到方法的Dex指令码。需要注意一点的是第一项id值，只会在这一组块的第一个位置写入确切值，后面的值均为与第一值相比的增差。

### 5. 解析过程

为取得某一类的所有方法，首先要对Dex文件做一个预处理：即按id的序存下所有Dex中的字符串，这样才可以方便的判断我们读取到的类的类名、方法名等等。这一操作通过对Dex Header的解析即可实现，读取到偏移位并按尺寸分配存入。接下来对Dex的*class\_def\_item*进行遍历，并通过其中class的id索引到type并再此索引到字符串，即可与我们提供的类名做比较，如发现相符，则进行下一步，对类的方法进行解析。如果这一步解析是供给于OAT的，则直接返回类的序号即可。

对于进一步解析，首先需要获取直接方法和虚方法的尺寸，然后依次遍历，还可以通过附加的*method\_id\_item*得到方法的类名和方法名。流程如下图：

![img]()
